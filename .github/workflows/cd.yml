# =============================================================================
# GitHub Actions CD Pipeline
# Continuous Deployment to Kubernetes
# =============================================================================

name: CD Pipeline

on:
  # Only run CD after CI Pipeline succeeds on main
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==========================================================================
  # Deploy to Kubernetes
  # ==========================================================================
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Check if Kubernetes is configured
        id: check-kube
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          if [ -n "$KUBE_CONFIG" ]; then
            echo "has_kube=true" >> $GITHUB_OUTPUT
          else
            echo "has_kube=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è KUBE_CONFIG secret not set - skipping K8s deployment"
          fi
      
      - name: Configure Kubernetes context
        if: steps.check-kube.outputs.has_kube == 'true'
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Update image tag in manifests
        run: |
          # Manifests live in k8s/local/ - pin image to exact commit SHA
          sed -i "s|ghcr.io/${{ env.IMAGE_NAME }}:latest|ghcr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}|g" k8s/local/deployment.yaml
          echo "=== Updated image tag ==="
          grep "image:" k8s/local/deployment.yaml
      
      - name: Apply Kubernetes manifests
        if: steps.check-kube.outputs.has_kube == 'true'
        run: |
          kubectl apply -f k8s/local/namespace.yaml
          kubectl apply -f k8s/local/configmap.yaml
          kubectl apply -f k8s/local/deployment.yaml
          kubectl apply -f k8s/local/service.yaml
      
      - name: Wait for deployment rollout
        if: steps.check-kube.outputs.has_kube == 'true'
        run: |
          kubectl rollout status deployment/cats-dogs-classifier \
            -n cats-dogs-classifier \
            --timeout=300s
      
      - name: Get deployment status
        if: steps.check-kube.outputs.has_kube == 'true'
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment cats-dogs-classifier -n cats-dogs-classifier
          echo ""
          echo "=== Pods Status ==="
          kubectl get pods -n cats-dogs-classifier
          echo ""
          echo "=== Service Status ==="
          kubectl get svc -n cats-dogs-classifier
      
      - name: Log deployment info (no K8s)
        if: steps.check-kube.outputs.has_kube != 'true'
        run: |
          echo "üì¶ Container image built and pushed:"
          echo "   ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "   ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "üöÄ To deploy locally:"
          echo "   podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "   podman run -d --name cats-dogs-api -p 8000:8000 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"

  # ==========================================================================
  # Smoke Tests
  # ==========================================================================
  smoke-tests:
    name: Post-Deploy Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install test dependencies
        # Pillow required by smoke_test.py to create synthetic test images
        run: pip install requests pytest Pillow
      
      - name: Configure Kubernetes context for smoke tests
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          if [ -n "$KUBE_CONFIG" ]; then
            mkdir -p $HOME/.kube
            echo "$KUBE_CONFIG" | base64 -d > $HOME/.kube/config
            chmod 600 $HOME/.kube/config
            echo "has_kube=true" >> $GITHUB_ENV
          else
            echo "has_kube=false" >> $GITHUB_ENV
          fi

      - name: Port-forward service for smoke tests
        if: env.has_kube == 'true'
        run: |
          kubectl port-forward svc/cats-dogs-classifier 8000:8000 -n cats-dogs-classifier &
          echo $! > /tmp/pf.pid
          for i in $(seq 1 15); do
            sleep 2
            curl -sf http://localhost:8000/health > /dev/null 2>&1 && echo "Service ready" && break || echo "  Attempt $i/15"
          done

      - name: Run smoke tests
        # smoke_test.py exits 1 on failure - this WILL fail the pipeline
        env:
          SERVICE_URL: ${{ secrets.SERVICE_URL }}
        run: |
          if [ -n "$SERVICE_URL" ]; then
            TARGET_URL="$SERVICE_URL"
          elif [ "$has_kube" = "true" ]; then
            TARGET_URL="http://localhost:8000"
          else
            echo "WARNING: No KUBE_CONFIG or SERVICE_URL secret set - smoke tests skipped"
            exit 0
          fi
          echo "Running smoke tests against: $TARGET_URL"
          python scripts/smoke_test.py --url "$TARGET_URL" --wait --max-attempts 20

      - name: Cleanup port-forward
        if: always()
        run: |
          [ -f /tmp/pf.pid ] && kill "$(cat /tmp/pf.pid)" 2>/dev/null || true

      - name: Report smoke test failure
        if: failure()
        run: |
          echo "::error::Smoke tests FAILED - deployment is unhealthy!"
          echo "::error::Check logs: kubectl logs -l app=cats-dogs-classifier -n cats-dogs-classifier"
          exit 1

  # ==========================================================================
  # Notify on Completion
  # ==========================================================================
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: always()
    
    steps:
      - name: Deployment Success
        if: ${{ needs.deploy.result == 'success' && needs.smoke-tests.result == 'success' }}
        run: |
          echo "‚úÖ Deployment pipeline completed successfully!"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "üîó Pull the image:"
          echo "   podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
      
      - name: Deployment Failed
        if: needs.deploy.result == 'failure'
        run: |
          echo "‚ùå Deployment failed!"
          exit 1

