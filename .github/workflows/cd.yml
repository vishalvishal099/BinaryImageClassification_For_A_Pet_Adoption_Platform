# =============================================================================# =============================================================================

# GitHub Actions CD Pipeline# GitHub Actions CD Pipeline

# Continuous Deployment to Kubernetes# Continuous Deployment to Kubernetes

# =============================================================================# =============================================================================



name: CD Pipelinename: CD Pipeline



on:on:

  push:  push:

    branches: [main]    branches: [main]

  workflow_dispatch:  workflow_dispatch:

    inputs:    inputs:

      environment:      environment:

        description: 'Deployment environment'        description: 'Deployment environment'

        required: true        required: true

        default: 'staging'        default: 'staging'

        type: choice        type: choice

        options:        options:

          - staging          - staging

          - production          - production



env:env:

  REGISTRY: ghcr.io  REGISTRY: ghcr.io

  IMAGE_NAME: ${{ github.repository }}  IMAGE_NAME: ${{ github.repository }}



jobs:jobs:

  # ==========================================================================  # ==========================================================================

  # Deploy to Kubernetes  # Deploy to Kubernetes

  # ==========================================================================  # ==========================================================================

  deploy:  deploy:

    name: Deploy to Kubernetes    name: Deploy to Kubernetes

    runs-on: ubuntu-latest    runs-on: ubuntu-latest

    environment: ${{ github.event.inputs.environment || 'staging' }}    environment: ${{ github.event.inputs.environment || 'staging' }}

        

    # Set outputs for deployment status    steps:

    outputs:      - name: Checkout repository

      deployed: ${{ steps.check-kube.outputs.has_config }}        uses: actions/checkout@v4

          

    steps:      - name: Set up kubectl

      - name: Checkout repository        uses: azure/setup-kubectl@v3

        uses: actions/checkout@v4        with:

                version: 'v1.28.0'

      - name: Check Kubernetes config      

        id: check-kube      - name: Configure Kubernetes context

        env:        run: |

          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}          mkdir -p $HOME/.kube

        run: |          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config

          if [ -n "$KUBE_CONFIG" ]; then          chmod 600 $HOME/.kube/config

            echo "has_config=true" >> $GITHUB_OUTPUT        if: ${{ secrets.KUBE_CONFIG != '' }}

            echo "‚úÖ Kubernetes config found"      

          else      - name: Update image tag in manifests

            echo "has_config=false" >> $GITHUB_OUTPUT        run: |

            echo "‚ö†Ô∏è No Kubernetes config - skipping K8s deployment"          cd k8s

            echo "‚ÑπÔ∏è Container image available at: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"          # Update the image tag in deployment manifest

          fi          sed -i "s|IMAGE_TAG|${{ github.sha }}|g" deployment.yaml

                sed -i "s|IMAGE_REGISTRY|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}|g" deployment.yaml

      - name: Set up kubectl          cat deployment.yaml

        if: steps.check-kube.outputs.has_config == 'true'      

        uses: azure/setup-kubectl@v3      - name: Apply Kubernetes manifests

        with:        run: |

          version: 'v1.28.0'          kubectl apply -f k8s/namespace.yaml

                kubectl apply -f k8s/configmap.yaml

      - name: Configure Kubernetes context          kubectl apply -f k8s/deployment.yaml

        if: steps.check-kube.outputs.has_config == 'true'          kubectl apply -f k8s/service.yaml

        env:          kubectl apply -f k8s/hpa.yaml || true

          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}        if: ${{ secrets.KUBE_CONFIG != '' }}

        run: |      

          mkdir -p $HOME/.kube      - name: Wait for deployment rollout

          echo "$KUBE_CONFIG" | base64 -d > $HOME/.kube/config        run: |

          chmod 600 $HOME/.kube/config          kubectl rollout status deployment/cats-dogs-classifier \

                  -n cats-dogs-classifier \

      - name: Update image tag in manifests            --timeout=300s

        run: |        if: ${{ secrets.KUBE_CONFIG != '' }}

          cd k8s      

          # Update the image tag in deployment manifest      - name: Get deployment status

          sed -i "s|IMAGE_TAG|${{ github.sha }}|g" deployment.yaml        run: |

          sed -i "s|IMAGE_REGISTRY|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}|g" deployment.yaml          echo "=== Deployment Status ==="

          cat deployment.yaml          kubectl get deployment cats-dogs-classifier -n cats-dogs-classifier

                echo ""

      - name: Apply Kubernetes manifests          echo "=== Pods Status ==="

        if: steps.check-kube.outputs.has_config == 'true'          kubectl get pods -n cats-dogs-classifier

        run: |          echo ""

          kubectl apply -f k8s/namespace.yaml          echo "=== Service Status ==="

          kubectl apply -f k8s/configmap.yaml          kubectl get svc -n cats-dogs-classifier

          kubectl apply -f k8s/deployment.yaml        if: ${{ secrets.KUBE_CONFIG != '' }}

          kubectl apply -f k8s/service.yaml

          kubectl apply -f k8s/hpa.yaml || true  # ==========================================================================

        # Smoke Tests

      - name: Wait for deployment rollout  # ==========================================================================

        if: steps.check-kube.outputs.has_config == 'true'  smoke-tests:

        run: |    name: Post-Deploy Smoke Tests

          kubectl rollout status deployment/cats-dogs-classifier \    runs-on: ubuntu-latest

            -n cats-dogs-classifier \    needs: deploy

            --timeout=300s    

          steps:

      - name: Get deployment status      - name: Checkout repository

        if: steps.check-kube.outputs.has_config == 'true'        uses: actions/checkout@v4

        run: |      

          echo "=== Deployment Status ==="      - name: Set up Python

          kubectl get deployment cats-dogs-classifier -n cats-dogs-classifier        uses: actions/setup-python@v5

          echo ""        with:

          echo "=== Pods Status ==="          python-version: '3.10'

          kubectl get pods -n cats-dogs-classifier      

          echo ""      - name: Install test dependencies

          echo "=== Service Status ==="        run: pip install requests pytest

          kubectl get svc -n cats-dogs-classifier      

            - name: Get service URL

      - name: Summary (No K8s deployment)        id: get-url

        if: steps.check-kube.outputs.has_config != 'true'        run: |

        run: |          # For local testing or when KUBE_CONFIG is not set

          echo "## üì¶ Deployment Summary" >> $GITHUB_STEP_SUMMARY          if [ -z "${{ secrets.SERVICE_URL }}" ]; then

          echo "" >> $GITHUB_STEP_SUMMARY            echo "SERVICE_URL=http://localhost:8000" >> $GITHUB_OUTPUT

          echo "No Kubernetes cluster configured. Image available for manual deployment:" >> $GITHUB_STEP_SUMMARY          else

          echo "" >> $GITHUB_STEP_SUMMARY            echo "SERVICE_URL=${{ secrets.SERVICE_URL }}" >> $GITHUB_OUTPUT

          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY          fi

          echo "# Pull the image" >> $GITHUB_STEP_SUMMARY      

          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY      - name: Run smoke tests

          echo "" >> $GITHUB_STEP_SUMMARY        run: |

          echo "# Run locally" >> $GITHUB_STEP_SUMMARY          python scripts/smoke_test.py --url ${{ steps.get-url.outputs.SERVICE_URL }}

          echo "docker run -d -p 8000:8000 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY        # Smoke tests MUST pass - no continue-on-error

          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY      

      - name: Report smoke test results

  # ==========================================================================        if: failure()

  # Smoke Tests        run: |

  # ==========================================================================          echo "::error::Smoke tests failed! Please check the deployment."

  smoke-tests:          exit 1

    name: Post-Deploy Smoke Tests

    runs-on: ubuntu-latest  # ==========================================================================

    needs: deploy  # Notify on Completion

    # Only run smoke tests if K8s deployment happened  # ==========================================================================

    if: needs.deploy.outputs.deployed == 'true'  notify:

        name: Notify Deployment Status

    steps:    runs-on: ubuntu-latest

      - name: Checkout repository    needs: [deploy, smoke-tests]

        uses: actions/checkout@v4    if: always()

          

      - name: Set up Python    steps:

        uses: actions/setup-python@v5      - name: Deployment Success

        with:        if: ${{ needs.deploy.result == 'success' && needs.smoke-tests.result == 'success' }}

          python-version: '3.10'        run: |

                echo "‚úÖ Deployment successful!"

      - name: Install test dependencies          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

        run: pip install requests pytest      

            - name: Deployment Failed

      - name: Get service URL        if: ${{ needs.deploy.result == 'failure' || needs.smoke-tests.result == 'failure' }}

        id: get-url        run: |

        env:          echo "‚ùå Deployment failed!"

          SERVICE_URL: ${{ secrets.SERVICE_URL }}          exit 1

        run: |
          if [ -z "$SERVICE_URL" ]; then
            echo "SERVICE_URL=http://localhost:8000" >> $GITHUB_OUTPUT
          else
            echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          fi
      
      - name: Run smoke tests
        run: |
          python scripts/smoke_test.py --url ${{ steps.get-url.outputs.SERVICE_URL }}
      
      - name: Report smoke test results
        if: failure()
        run: |
          echo "::error::Smoke tests failed! Please check the deployment."
          exit 1

  # ==========================================================================
  # Notify on Completion
  # ==========================================================================
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: always()
    
    steps:
      - name: Deployment Success
        if: needs.deploy.result == 'success' && (needs.smoke-tests.result == 'success' || needs.smoke-tests.result == 'skipped')
        run: |
          echo "‚úÖ Deployment successful!"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
      
      - name: Deployment Failed
        if: needs.deploy.result == 'failure' || needs.smoke-tests.result == 'failure'
        run: |
          echo "‚ùå Deployment failed!"
          exit 1
