# =============================================================================
# GitHub Actions CD Pipeline — GitOps via ArgoCD
# Flow: CI builds image → CD updates k8s manifest → ArgoCD auto-syncs cluster
# =============================================================================

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: latest)'
        required: false
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # Job 1 — Update Kubernetes manifest → push → ArgoCD auto-deploys
  # ============================================================================
  update-manifest:
    name: Update K8s Manifest (GitOps)
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tag
        id: set-tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            SHA="${{ github.event.workflow_run.head_sha }}"
            TAG="${SHA:0:7}"
          fi
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT
          echo "Deploying image tag: $TAG"

      - name: Update image tag in deployment manifest
        run: |
          TAG="${{ steps.set-tag.outputs.image_tag }}"
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          IMAGE="${{ env.REGISTRY }}/${OWNER}/${REPO}"

          sed -i "s|image: ${IMAGE}:.*|image: ${IMAGE}:${TAG}|g" k8s/local/deployment.yaml

          echo "=== Updated manifest ==="
          grep "image:" k8s/local/deployment.yaml

      - name: Commit and push manifest update
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/local/deployment.yaml
          if git diff --cached --quiet; then
            echo "No changes — image tag already up to date."
          else
            git commit -m "chore(cd): deploy image :${{ steps.set-tag.outputs.image_tag }} [skip ci]"
            git push origin main
            echo "Manifest pushed — ArgoCD will auto-sync within 3 minutes."
          fi

      - name: Write job summary
        run: |
          echo "## CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ steps.set-tag.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Manifest | \`k8s/local/deployment.yaml\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD App | \`cats-dogs-classifier\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Sync Mode | Auto (prune + selfHeal) |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 2 — Smoke Tests (skipped gracefully if no SERVICE_URL secret)
  # ============================================================================
  smoke-tests:
    name: Post-Deploy Smoke Tests
    runs-on: ubuntu-latest
    needs: update-manifest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install test dependencies
        run: pip install requests pytest Pillow

      - name: Run smoke tests
        env:
          SERVICE_URL: ${{ secrets.SERVICE_URL }}
        run: |
          if [ -z "$SERVICE_URL" ]; then
            echo "SERVICE_URL secret not set — smoke tests skipped."
            echo "Set SERVICE_URL in GitHub repo Settings > Secrets to enable."
            exit 0
          fi
          echo "Running smoke tests against: $SERVICE_URL"
          python scripts/smoke_test.py --url "$SERVICE_URL" --wait --max-attempts 20

  # ============================================================================
  # Job 3 — Notify final status
  # ============================================================================
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [update-manifest, smoke-tests]
    if: always()

    steps:
      - name: Success
        if: ${{ needs.update-manifest.result == 'success' }}
        run: |
          echo "✅ CD Pipeline complete!"
          echo "  Tag   : ${{ needs.update-manifest.outputs.image_tag }}"
          echo "  Image : ghcr.io/${{ env.IMAGE_NAME }}:${{ needs.update-manifest.outputs.image_tag }}"
          echo "  ArgoCD: https://localhost:9443 (app: cats-dogs-classifier)"
          echo "  Grafana: http://localhost:3000/d/pet-adoption-ml-v2"

      - name: Failure
        if: ${{ needs.update-manifest.result == 'failure' }}
        run: |
          echo "❌ CD Pipeline failed at manifest update step!"
          exit 1
