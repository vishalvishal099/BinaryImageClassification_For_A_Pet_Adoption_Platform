# =============================================================================
# GitHub Actions CD Pipeline
# Continuous Deployment to Kubernetes
# =============================================================================

name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==========================================================================
  # Deploy to Kubernetes
  # ==========================================================================
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Configure Kubernetes context
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
        if: ${{ secrets.KUBE_CONFIG != '' }}
      
      - name: Update image tag in manifests
        run: |
          cd k8s
          # Update the image tag in deployment manifest
          sed -i "s|IMAGE_TAG|${{ github.sha }}|g" deployment.yaml
          sed -i "s|IMAGE_REGISTRY|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}|g" deployment.yaml
          cat deployment.yaml
      
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/hpa.yaml || true
        if: ${{ secrets.KUBE_CONFIG != '' }}
      
      - name: Wait for deployment rollout
        run: |
          kubectl rollout status deployment/cats-dogs-classifier \
            -n cats-dogs-classifier \
            --timeout=300s
        if: ${{ secrets.KUBE_CONFIG != '' }}
      
      - name: Get deployment status
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment cats-dogs-classifier -n cats-dogs-classifier
          echo ""
          echo "=== Pods Status ==="
          kubectl get pods -n cats-dogs-classifier
          echo ""
          echo "=== Service Status ==="
          kubectl get svc -n cats-dogs-classifier
        if: ${{ secrets.KUBE_CONFIG != '' }}

  # ==========================================================================
  # Smoke Tests
  # ==========================================================================
  smoke-tests:
    name: Post-Deploy Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install test dependencies
        run: pip install requests pytest
      
      - name: Get service URL
        id: get-url
        run: |
          # For local testing or when KUBE_CONFIG is not set
          if [ -z "${{ secrets.SERVICE_URL }}" ]; then
            echo "SERVICE_URL=http://localhost:8000" >> $GITHUB_OUTPUT
          else
            echo "SERVICE_URL=${{ secrets.SERVICE_URL }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Run smoke tests
        run: |
          python scripts/smoke_test.py --url ${{ steps.get-url.outputs.SERVICE_URL }}
        continue-on-error: true
      
      - name: Report smoke test results
        if: failure()
        run: |
          echo "::error::Smoke tests failed! Please check the deployment."

  # ==========================================================================
  # Notify on Completion
  # ==========================================================================
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: always()
    
    steps:
      - name: Deployment Success
        if: ${{ needs.deploy.result == 'success' && needs.smoke-tests.result == 'success' }}
        run: |
          echo "✅ Deployment successful!"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
      
      - name: Deployment Failed
        if: ${{ needs.deploy.result == 'failure' || needs.smoke-tests.result == 'failure' }}
        run: |
          echo "❌ Deployment failed!"
          exit 1
