# =============================================================================
# GitHub Actions CD Pipeline
# Continuous Deployment to Kubernetes
# =============================================================================

name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==========================================================================
  # Deploy to Kubernetes
  # ==========================================================================
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Check if Kubernetes is configured
        id: check-kube
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          if [ -n "$KUBE_CONFIG" ]; then
            echo "has_kube=true" >> $GITHUB_OUTPUT
          else
            echo "has_kube=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è KUBE_CONFIG secret not set - skipping K8s deployment"
          fi
      
      - name: Configure Kubernetes context
        if: steps.check-kube.outputs.has_kube == 'true'
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Update image tag in manifests
        run: |
          cd k8s
          # Update the image tag in deployment manifest
          sed -i "s|IMAGE_TAG|${{ github.sha }}|g" deployment.yaml
          sed -i "s|IMAGE_REGISTRY|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}|g" deployment.yaml
          cat deployment.yaml
      
      - name: Apply Kubernetes manifests
        if: steps.check-kube.outputs.has_kube == 'true'
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/hpa.yaml || true
      
      - name: Wait for deployment rollout
        if: steps.check-kube.outputs.has_kube == 'true'
        run: |
          kubectl rollout status deployment/cats-dogs-classifier \
            -n cats-dogs-classifier \
            --timeout=300s
      
      - name: Get deployment status
        if: steps.check-kube.outputs.has_kube == 'true'
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment cats-dogs-classifier -n cats-dogs-classifier
          echo ""
          echo "=== Pods Status ==="
          kubectl get pods -n cats-dogs-classifier
          echo ""
          echo "=== Service Status ==="
          kubectl get svc -n cats-dogs-classifier
      
      - name: Log deployment info (no K8s)
        if: steps.check-kube.outputs.has_kube != 'true'
        run: |
          echo "üì¶ Container image built and pushed:"
          echo "   ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "   ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "üöÄ To deploy locally:"
          echo "   podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "   podman run -d --name cats-dogs-api -p 8000:8000 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"

  # ==========================================================================
  # Smoke Tests
  # ==========================================================================
  smoke-tests:
    name: Post-Deploy Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install test dependencies
        run: pip install requests pytest
      
      - name: Get service URL
        id: get-url
        env:
          SERVICE_URL_SECRET: ${{ secrets.SERVICE_URL }}
        run: |
          if [ -z "$SERVICE_URL_SECRET" ]; then
            echo "SERVICE_URL=http://localhost:8000" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è SERVICE_URL not set - using localhost for testing"
          else
            echo "SERVICE_URL=$SERVICE_URL_SECRET" >> $GITHUB_OUTPUT
          fi
      
      - name: Run smoke tests (skip if no URL)
        continue-on-error: true
        run: |
          if [ "${{ steps.get-url.outputs.SERVICE_URL }}" != "http://localhost:8000" ]; then
            python scripts/smoke_test.py --url ${{ steps.get-url.outputs.SERVICE_URL }}
          else
            echo "‚ÑπÔ∏è Skipping smoke tests - no deployed service URL configured"
            echo "   Set SERVICE_URL secret to enable smoke tests"
          fi
      
      - name: Report smoke test results
        if: failure()
        run: |
          echo "::warning::Smoke tests were skipped or failed"

  # ==========================================================================
  # Notify on Completion
  # ==========================================================================
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: always()
    
    steps:
      - name: Deployment Success
        if: needs.deploy.result == 'success'
        run: |
          echo "‚úÖ Deployment pipeline completed successfully!"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "üîó Pull the image:"
          echo "   podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
      
      - name: Deployment Failed
        if: needs.deploy.result == 'failure'
        run: |
          echo "‚ùå Deployment failed!"
          exit 1
